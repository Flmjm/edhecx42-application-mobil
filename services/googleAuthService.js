// Import conditionnel pour compatibilit√© Expo Go
let GoogleSignin;
try {
  GoogleSignin = require('@react-native-google-signin/google-signin').GoogleSignin;
} catch (error) {
  console.log('üì± Module Google Sign-In non disponible avec Expo Go');
}

import { signInWithCredential, GoogleAuthProvider } from 'firebase/auth';
import { auth, db } from '../firebaseConfig';
import { doc, setDoc, getDoc, updateDoc } from 'firebase/firestore';
import GoogleAuthErrorHandler from './googleAuthErrorHandler';

class GoogleAuthService {
  constructor() {
    this.configure();
  }

  // Configuration Google Sign-In
  configure() {
    try {
      if (GoogleSignin) {
        GoogleSignin.configure({
          // WebClientId est OBLIGATOIRE - r√©cup√©rer depuis Firebase Console > Authentication > Sign-in method > Google
          webClientId: '922969943051-qrkuqeou6jkvjge8jmmb8vd0i01vbolh.apps.googleusercontent.com',
          offlineAccess: true, // Pour obtenir le refresh token
          hostedDomain: '', // Domaine sp√©cifique (optionnel)
          forceCodeForRefreshToken: true, // Force le refresh token
          accountName: '', // Nom du compte (optionnel)
          
          // iOS Client ID (optionnel, am√©liore les performances sur iOS)
          // iosClientId: 'VOTRE_IOS_CLIENT_ID.apps.googleusercontent.com',
        });
      } else {
        console.log('üì± Mode d√©mo Expo Go - Google Sign-In simul√©');
      }
    } catch (error) {
      console.error('Erreur configuration Google Sign-In:', error);
    }
  }

  // Connexion avec Google
  async signInWithGoogle() {
    try {
      if (!GoogleSignin) {
        // Mode d√©mo pour Expo Go
        return this.signInDemo();
      }
      
      // 1. V√©rifier si Google Play Services est disponible
      await GoogleSignin.hasPlayServices();
      
      // 2. Obtenir les informations utilisateur de Google
      const userInfo = await GoogleSignin.signIn();
      
      // 3. Cr√©er les credentials Firebase
      const googleCredential = GoogleAuthProvider.credential(userInfo.idToken);
      
      // 4. Connexion √† Firebase avec les credentials Google
      const firebaseUserCredential = await signInWithCredential(auth, googleCredential);
      const firebaseUser = firebaseUserCredential.user;
      
      // 5. Cr√©er ou mettre √† jour le profil utilisateur
      await this.createOrUpdateUserProfile(firebaseUser, userInfo.user);
      
      return {
        success: true,
        user: firebaseUser,
        googleUser: userInfo.user
      };
      
    } catch (error) {
      GoogleAuthErrorHandler.logError(error, 'signInWithGoogle');
      
      const errorMessage = GoogleAuthErrorHandler.getErrorMessage(error);
      const isRetryable = GoogleAuthErrorHandler.isRetryableError(error);
      const suggestion = GoogleAuthErrorHandler.getSuggestion(error);
      
      return {
        success: false,
        error: errorMessage,
        isRetryable,
        suggestion,
        originalError: error
      };
    }
  }

  // Mode d√©mo pour Expo Go
  async signInDemo() {
    try {
      // Simuler une connexion r√©ussie
      await new Promise(resolve => setTimeout(resolve, 1500)); // D√©lai r√©aliste
      
      const demoUser = {
        success: true,
        user: {
          uid: 'demo_user_' + Date.now(),
          email: 'demo@foodapp.com',
          displayName: 'Utilisateur D√©mo',
          photoURL: 'https://via.placeholder.com/150/4CAF50/FFFFFF/?text=Demo'
        },
        googleUser: {
          id: 'demo_google_id',
          name: 'Utilisateur D√©mo',
          email: 'demo@foodapp.com',
          photo: 'https://via.placeholder.com/150/4CAF50/FFFFFF/?text=Demo'
        },
        isDemo: true
      };
      
      console.log('üéØ Mode d√©mo Expo Go - Connexion simul√©e r√©ussie');
      return demoUser;
      
    } catch (error) {
      return {
        success: false,
        error: 'Erreur dans le mode d√©mo',
        isDemo: true
      };
    }
  }

  // D√©connexion Google
  async signOutGoogle() {
    try {
      await GoogleSignin.signOut();
      await auth.signOut();
      return { success: true };
    } catch (error) {
      console.error('Erreur d√©connexion Google:', error);
      return { success: false, error: 'Erreur de d√©connexion' };
    }
  }

  // Cr√©er ou mettre √† jour le profil utilisateur
  async createOrUpdateUserProfile(firebaseUser, googleUser) {
    try {
      const userRef = doc(db, 'users', firebaseUser.uid);
      const userDoc = await getDoc(userRef);
      
      const userData = {
        uid: firebaseUser.uid,
        email: firebaseUser.email,
        displayName: firebaseUser.displayName || googleUser.name,
        photoURL: firebaseUser.photoURL || googleUser.photo,
        provider: 'google',
        lastLoginAt: new Date(),
        isGoogleUser: true,
        googleId: googleUser.id,
      };

      if (userDoc.exists()) {
        // Mettre √† jour le profil existant
        await updateDoc(userRef, {
          ...userData,
          updatedAt: new Date()
        });
      } else {
        // Cr√©er un nouveau profil
        await setDoc(userRef, {
          ...userData,
          createdAt: new Date(),
          dietaryRestrictions: [],
          allergies: [],
          favoriteCategories: [],
          settings: {
            notifications: true,
            theme: 'light',
            language: 'fr'
          }
        });

        // Cr√©er aussi le profil Knorr par d√©faut
        await this.createKnorrProfile(firebaseUser.uid);
      }
      
    } catch (error) {
      console.error('Erreur cr√©ation profil:', error);
      throw error;
    }
  }

  // Cr√©er le profil Knorr pour les nouveaux utilisateurs Google
  async createKnorrProfile(userId) {
    try {
      const knorrRef = doc(db, 'knorr_user_profiles', userId);
      
      await setDoc(knorrRef, {
        userId,
        knorrLevel: 1,
        knorrXP: 0,
        rewardPoints: 0,
        badges: [],
        stats: {
          totalPosts: 0,
          totalViews: 0,
          totalLikes: 0,
          totalComments: 0,
          totalShares: 0,
          challengesCompleted: 0
        },
        followers: [],
        following: [],
        contentPreferences: {
          favoriteKnorrProducts: [],
          likedPosts: [],
          savedPosts: [],
          viewedPosts: []
        },
        createdAt: new Date(),
        lastActiveAt: new Date()
      });
      
    } catch (error) {
      console.error('Erreur cr√©ation profil Knorr:', error);
    }
  }

  // V√©rifier si l'utilisateur est connect√©
  async isSignedIn() {
    try {
      return await GoogleSignin.isSignedIn();
    } catch (error) {
      return false;
    }
  }

  // Obtenir les infos utilisateur Google actuel
  async getCurrentUser() {
    try {
      return await GoogleSignin.getCurrentUser();
    } catch (error) {
      return null;
    }
  }
}

export default new GoogleAuthService();
